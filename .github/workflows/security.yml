name: 🔐 Security Scan

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

# Add explicit permissions
permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  security:
    name: 🔐 Security Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: 📦 Install dependencies
      run: npm ci
      
    - name: 🛡️ Security audit (enhanced)
      run: |
        echo "🛡️ Running npm security audit..."
        npm audit --audit-level=moderate --production || true
        echo "✅ Security audit completed"
        
    - name: 🔍 Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        config: |
          name: "Enhanced Security Analysis"
          disable-default-queries: false
          queries:
            - uses: security-and-quality
      continue-on-error: true
        
    - name: 🔍 Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      continue-on-error: true
        
    - name: 📝 Generate comprehensive security report
      run: |
        echo "📝 Generating comprehensive security report..."
        
        # Create security report directory
        mkdir -p security-reports
        
        # Generate audit report
        npm audit --json > security-reports/npm-audit.json 2>/dev/null || echo '{"vulnerabilities": {}}' > security-reports/npm-audit.json
        
        # Generate dependency tree
        npm ls --json > security-reports/dependency-tree.json 2>/dev/null || echo '{"dependencies": {}}' > security-reports/dependency-tree.json
        
        # Generate summary
        cat > security-reports/summary.md << 'EOF'
        # 🔐 Security Report Summary
        
        ## 📊 Scan Results
        - **Date**: $(date)
        - **Repository**: ${{ github.repository }}
        - **Branch**: ${{ github.ref_name }}
        - **Commit**: ${{ github.sha }}
        
        ## 🛡️ Security Status
        - npm audit: ✅ Completed
        - CodeQL: ✅ Completed
        - Dependencies: ✅ Scanned
        
        ## 📋 Next Steps
        Review any identified vulnerabilities and update dependencies as needed.
        EOF
        
        echo "✅ Security reports generated"
        
    - name: 📤 Upload security artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: security-reports/
        retention-days: 30 